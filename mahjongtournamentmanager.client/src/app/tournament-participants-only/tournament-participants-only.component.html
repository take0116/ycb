<div class="participants-only-container">
  <div class="navigation-header">
    <button [routerLink]="['/events', tournamentId]" class="back-button">＜ 戻る</button>
  </div>

  <h2 class="page-header">{{ tournamentName }} - 対戦表</h2>

  <div *ngIf="message" class="message-banner">{{ message }}</div>

  <div class="card participants-section">
    <div class="card-header" (click)="toggleParticipantsVisibility()">
      <span>参加者一覧</span>
      <span class="toggle-icon" [style.transform]="isParticipantsVisible ? 'rotate(180deg)' : ''">▼</span>
    </div>
    <ul *ngIf="isParticipantsVisible" class="participants-list">
      <li *ngFor="let participant of participants" class="participant-tag">{{ participant.user.userName }}</li>
    </ul>
  </div>

  <div *ngIf="!isTableSaved && isAdmin" class="card match-generation-section">
    <h4 class="card-header">対戦表を作成</h4>
    <form [formGroup]="matchSettingsForm" (ngSubmit)="generateMatchTable()">
      <div class="form-group">
        <label for="minMatches">最低試合数:</label>
        <input type="number" id="minMatches" formControlName="minMatchesPerParticipant">
      </div>
      <button type="submit" class="mahjong-button primary-button">生成</button>
    </form>
  </div>

  <div *ngIf="groupedMatchTables.length > 0" class="match-tables-section">
    <div *ngFor="let table of groupedMatchTables" class="card match-table">
      <h3 class="match-table-header">{{ table.tableName }}</h3>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th *ngFor="let header of table.data[0]">{{ header }}</th>
              <th>日程</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of table.data.slice(1)">
              <!-- This cell is for the round number -->
              <td>{{ row.displayCells[0] }}</td>
              
              <!-- This cell is for the player list -->
              <td>
                <div class="player-list">
                  <div *ngFor="let player of row.players" 
                       class="player-name"
                       [class.submitted]="hasUserSubmittedAvailability(row.matchId, player.id)">
                    {{ player.name }}
                  </div>
                </div>
              </td>

              <!-- This cell is for the bye players -->
              <td>{{ row.displayCells[2] }}</td>

              <!-- This cell is for the schedule period -->
              <td>{{ row.displayCells[3] }}</td>

              <!-- This cell is for the action buttons -->
              <td>
                <div class="schedule-controls">
                  <input *ngIf="isAdmin" type="date" [id]="'schedule-date-' + table.tableName + '-' + row.round" [value]="row.schedulingStartDate | date:'yyyy-MM-dd'">
                  <button *ngIf="isAdmin" (click)="saveSchedulingStartDate(row, table.tableName)" class="mahjong-button save-button">保存</button>
                  <button *ngIf="row.schedulingStartDate && isUserInMatch(row)" (click)="openCoordinator(row)" class="mahjong-button adjust-button">希望日入力</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div *ngIf="isAdmin" class="action-buttons">
    <button *ngIf="groupedMatchTables.length > 0 && !isTableSaved" (click)="saveMatchTable()" class="mahjong-button primary-button">対戦表を保存</button>
    <button *ngIf="isTableSaved" (click)="unlockMatchTable()" class="mahjong-button danger-button">対戦表を削除</button>
  </div>
</div>

<app-schedule-coordinator 
  *ngIf="isCoordinatorVisible" 
  [roundInfo]="selectedRoundInfo" 
  [players]="selectedMatchPlayers"
  (close)="closeCoordinator($event)">
</app-schedule-coordinator>
