<div class="participants-only-container">
  <h2>{{ tournamentName }} - 対戦表</h2>

  <div *ngIf="message" class="message-banner">{{ message }}</div>

  <div class="participants-section">
    <h3 (click)="toggleParticipantsVisibility()">
      参加者一覧
      <span class="toggle-icon">{{ isParticipantsVisible ? '▲' : '▼' }}</span>
    </h3>
    <ul *ngIf="isParticipantsVisible">
      <li *ngFor="let participant of participants">{{ participant.user.userName }}</li>
    </ul>
  </div>

  <div *ngIf="!isTableSaved" class="match-generation-section">
    <h4>対戦表を作成</h4>
    <form [formGroup]="matchSettingsForm" (ngSubmit)="generateMatchTable()">
      <div class="form-group">
        <label for="minMatches">最低試合数:</label>
        <input type="number" id="minMatches" formControlName="minMatchesPerParticipant">
      </div>
      <button type="submit" class="mahjong-button">生成</button>
    </form>
  </div>

  <div *ngIf="groupedMatchTables.length > 0" class="match-tables-section">
    <div *ngFor="let table of groupedMatchTables" class="match-table">
      <h4>{{ table.tableName }}</h4>
      <table>
        <thead>
          <tr>
            <th *ngFor="let header of table.data[0]">{{ header }}</th>
            <th>日程調整</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of table.data.slice(1)">
            <td *ngFor="let cell of row.displayCells">{{ cell }}</td>
            <td>
              <div class="schedule-controls">
                <input type="date" [id]="'schedule-date-' + table.tableName + '-' + row.round" [value]="row.schedulingStartDate | date:'yyyy-MM-dd'">
                <button *ngIf="authService.hasRole('Admin')" (click)="saveSchedulingStartDate(row, table.tableName)" class="mahjong-button save-button">保存</button>
                <button *ngIf="row.schedulingStartDate && isUserInMatch(row)" (click)="openCoordinator(row)" class="mahjong-button adjust-button">調整</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="action-buttons">
    <button *ngIf="groupedMatchTables.length > 0 && !isTableSaved" (click)="saveMatchTable()" class="mahjong-button primary-button">対戦表を保存</button>
    <button *ngIf="isTableSaved" (click)="unlockMatchTable()" class="mahjong-button danger-button">対戦表を削除</button>
  </div>
</div>

<app-schedule-coordinator 
  *ngIf="isCoordinatorVisible" 
  [roundInfo]="selectedRoundInfo" 
  [players]="selectedMatchPlayers"
  (close)="closeCoordinator()">
</app-schedule-coordinator>